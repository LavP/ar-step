# MATCH_PLATE_API
ATCH PLATE APIは、以下の条件に沿ったPLATEをDBから探し出しだす検索APIです。
また、検索結果は角度の緩い順にソートして返されます。

- 高さが合う
- 横幅が合う
- 段差の形状にプレートが合う
- 段差の形状にプレートがあった上で、許容された設置可能奥行き領域内に設置できる

APIはJSONを返し、URLに次のパラメタをつけてリクエストします。

|パラメタ|許可される値|説明|必須か|
|:-|:-|:-|:-|
|?height|`数値(cm)`|段差の高さを定義します|YES
|?width|`数値(cm)`|設置場所の横幅を定義します|YES
|?max_depth|`数値(cm)`|設置場所の許容される最大奥行を定義します|YES|
|?min_depth|`数値(cm)`|設置場所の許容される最小奥行を定義します|?step_typeが`one`の場合は不要|
|?step_type|`one` / `multiple` / `okayama`|設置場所の段差の形状を指定します|YES|


これらを指定してMATCH_PLATE_APIに投げると、 条件にあったものをピックアップします。
さらにその情報は **傾斜が緩やかな順** となって返されます。

APIの内部処理のプロセスは、[フローチャートドキュメント](/Docs/MATCH_PLATE_API/flow.pdf)によって定義しています。

## APIファイルの実態
このAPIファイルは、WordPressの固定ページとして存在します。<br>
そのため、WordPressテーマからみると次のディレクトリに存在します。

>/page-match_plate_api.php

WordPressの内部に入れ込むことで、PLATEの情報をWP_Queryによって取得することができます。

これにより、場合によっては豊富なWordPressプラグインの恩恵を受けることができます。


# 言語と実装方法について
処理はPHPで行う。
処理が1000ms以内に完遂するのであれば、表示ページのPHP内にincludeとして実装し、そうでない場合は、最終的にJSONとして生成されるようにし、表示ページのJSでこれを取得して表示する。

# 各一致条件の詳細
以下すべての条件を満たす必要がある。
すべての条件を満たした上で、設置場所の高さと許可される接地面積の中から角度が最も緩やかになる角度を各プレート毎に求め、角度が緩やかな順にして返す。


## 高さの条件
設置場所の高さに適合するプレートである。<br>
プレートは高さが可変なものがあるので、これを考慮する。

## 段差形状の条件別、奥行きの条件

段差の形状によって、奥行きの条件は変化する

### １段型
プレートの奥が、段差に接しているものと地面に接しているもの両方OK

奥が段差に接している場合は、段差の高さとプレートの奥行き（傾斜）から底辺を計算し、この底辺がクエリの最大奥行以内である必要がある。

奥が地面に接している場合は、プレートの奥行き（底辺）がクエリの最大奥行以内である必要がある。

### 階段型
プレートの奥が、段差に接する形状のもののみ対象とする

階段の上にプレートを置く場合、階段１段１段の角にプレートが接触するため、最小奥行きは（階段全体の奥行き/段数*(段数+1)）以上となる。
しかしこれは、AR_SCAN部分で傾斜の線をプレビュー表示した上で、斜辺の線が段差の角と接触しないことを確認しながら最小奥行きを決めてもらう。
そのため、このAPIに投げられた最小奥行きはニーズを満たしている。

よって、階段型の条件は、プレートの奥行き（斜辺）と設置場所の高さを使用し、底辺の長さを求めた上で、底辺の長さが（最小奥行き\<=底辺の長さ\<=最大奥行）の条件を満たす場合である。

### 岡山型
岡山県によく見られるが、側溝のように段差と地面の間に隙間があり、その隙間を超えなければならない場合はこの処理が必要

AR_SCANの段階で、斜辺をプレビュー表示しながら最小奥行きと最大奥行を決定してもらう。
そのため、このAPIに投げられるクエリはニーズを満たしている。

よって、岡山型の条件は、プレートの奥行き（斜辺）と設置場所の高さを使用し、底辺の長さを求めた上で、底辺の長さが（最小奥行き\<=底辺の長さ\<=最大奥行）の条件を満たす場合である。

## 横幅の条件
１枚のプレートだけで、設置場所の横幅をぴったり満たすことができれば良いが、そうもいかない。

### 余白の条件
そのため、何枚かを横に並べる必要があるのだが、それでもピッタリは行かない。<br>
必ず、左右に余白ができる。この余白が**10cm以内かつ設置場所の横幅全体の5%以内でかつプレートの横幅が120cm以上**でなければ、車椅子が脱輪する可能性があり危険である。

また、この条件を満たす場合は、何枚つなぎ合わせればよいのか求める。

### 接続可能か
プレートの中には、転落防止のために両端に出っ張りがあるものがある。<br>
この場合、繋げて使用することはできないため、このタイプのプレートの場合は、余白の条件を満たした上で、必要個数が１つだけの場合のみ候補に表示する